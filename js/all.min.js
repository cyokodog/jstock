var app=angular.module("app",["ui.router","ngAnimate","angular-loading-bar"]);app.constant("CONFIG",{API_ENDPOINT:"http://jquerydb.aws.af.cm/jstock/webapi/",PAGE_INFO:[{id:"home",name:"HOME"},{id:"library",name:"LIBRARY"},{id:"jser",name:"JSer"}]}),app.factory("fetchCategoryService",["$http","$q","CONFIG",function(t,e,r){return{exec:function(a){var c=e.defer();return t.jsonp(r.API_ENDPOINT,{params:angular.extend({callback:"JSON_CALLBACK",contentsType:"category"},a)}).success(function(t){c.resolve(t)}),c.promise}}}]),app.factory("fetchArticleService",["$http","$q","CONFIG",function(t,e,r){return{exec:function(a){["page","page_no","category_id","single_id"].forEach(function(t){a[t]=a[t]||"*"});var c=e.defer();return t.jsonp(r.API_ENDPOINT,{params:angular.extend({callback:"JSON_CALLBACK",contentsType:"article"},a)}).success(function(t){c.resolve(t)}),c.promise}}}]),app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t,e,r){function a(t,e){this.init.apply(this,Array.prototype.slice.call(arguments))}var c={template:'<list-page ctrl="ctrl" data="ctrl.data" state="ctrl.state"/>',controllerAs:"ctrl",controller:a},i={template:'<article-page ctrl="ctrl" data="ctrl.data" state="ctrl.state"/>',controllerAs:"ctrl",controller:a};e.otherwise("/"),t.state("home",{url:"/",views:{viewArticle:c}}).state("category",{url:"/{pageId:library|jser}/category/{categoryId:.+}",views:{viewArticle:c}}).state("page",{url:"/{pageId:library|jser}",views:{viewArticle:c}}).state("article",{url:"/{pageId:library|jser}/{articleId:.+}",views:{viewArticle:i}}),a.$inject=["$stateParams","fetchArticleService"],angular.extend(a.prototype,{init:function(t,e){var r=this,a=r.config={fetchArticleService:e,pageNo:1};r.state=t,r.fetchData(a.pageNo)},initJserCategory:function(){{var t=this;t.config}"jser"==t.state.pageId&&(t.data.plugins_qty>0?t.data.jserCategory="1"==t.data.jp_flg?{type:"japanese-creator",name:"Japanese Creator"}:{type:"creator",name:"Creator"}:"1"==t.data.jp_flg&&(t.data.jserCategory={type:"japanese-reviewer",name:"Japanese Reviewer"}))},fetchData:function(t,e){var r=this,a=r.config;a.fetchArticleService.exec({page:r.state.pageId||"home",page_no:a.pageNo,category_id:r.state.categoryId||"*",single_id:r.state.articleId||"*"}).then(function(t){if(e&&r.data){var c=r.data.article_list.concat(t.article_list);r.data=t,r.data.article_list=c}else r.data=t;r.data.info=t.article_list_info[0],r.data.isNextPage=r.data.info.next_page_no>a.pageNo,r.data.isPrevPage=!1,r.state.articleId&&r.initJserCategory(),e||setTimeout(function(){document.body.scrollTop=0},0)})},nextPage:function(){var t=this,e=t.config;!t.state.articleId&&t.data.isNextPage&&(e.pageNo++,t.fetchData(e.pageNo,!0),t.data.isNextPage=!1)},prevPage:function(){var t=this,e=t.config;e.pageNo--,t.fetchData(e.pageNo)}});var n=function(){return document.body.scrollTop||document.documentElement.scrollTop},o=function(){return document.body.scrollHeight||document.documentElement.scrollHeight},l=angular.element(window);l.on("scroll",function(t){if(console.log(n(),o()),o()-1e3<n()){var e=document.querySelector(".next-page");e&&e.click()}})}]),app.directive("siteNav",function(){return{scope:{},restrict:"E",templateUrl:"directive/site_nav.html",controllerAs:"ctrl",controller:["CONFIG","$stateParams",function(t,e){var r=this;r.pageInfo=t.PAGE_INFO,r.state=e}]}}),app.directive("listPage",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/list_page.html"}}),app.directive("articlePage",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/article_page.html"}}),app.directive("libraryCard",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/library_card.html"}}),app.directive("jserCard",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/jser_card.html"}}),app.directive("libraryArticle",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/library_article.html"}}),app.directive("jserArticle",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/jser_article.html"}}),app.directive("categoryList",function(){return{scope:{},require:"categoryList",restrict:"E",templateUrl:"directive/category_list.html",link:function(t,e,r,a){a.init()},controllerAs:"ctrl",controller:["$scope","fetchCategoryService",function(t,e){var r=this;r.data={},r.init=function(){e.exec().then(function(t){r.data.category=t})}}]}}),app.directive("fitSidebar",function(){return{scope:{},restrict:"A",transclude:!0,template:"<ng-transclude/>",link:function(t,e,r){$(e).fitSidebar({wrapper:".l-contents",responsiveWidth:960})}}});