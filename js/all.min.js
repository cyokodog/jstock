var app=angular.module("app",["ui.router","ngAnimate","angular-loading-bar"]);app.constant("CONFIG",{API_ENDPOINT:"http://jquerydb.aws.af.cm/jstock/webapi/",PAGE_INFO:[{id:"home",name:"HOME"},{id:"library",name:"LIBRARY"},{id:"jser",name:"JSer"}]}),app.factory("fetchCategoryService",["$http","$q","CONFIG",function(t,e,a){return{exec:function(r){var c=e.defer();return t.jsonp(a.API_ENDPOINT,{params:angular.extend({callback:"JSON_CALLBACK",contentsType:"category"},r)}).success(function(t){c.resolve(t)}),c.promise}}}]),app.factory("fetchArticleService",["$http","$q","CONFIG",function(t,e,a){return{exec:function(r){["page","page_no","category_id","single_id"].forEach(function(t){r[t]=r[t]||"*"});var c=e.defer();return t.jsonp(a.API_ENDPOINT,{params:angular.extend({callback:"JSON_CALLBACK",contentsType:"article"},r)}).success(function(t){c.resolve(t)}),c.promise}}}]),app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t,e,a){function r(t,e){this.init.apply(this,Array.prototype.slice.call(arguments))}var c={template:'<list-page ctrl="ctrl" data="ctrl.data" state="ctrl.state"/>',controllerAs:"ctrl",controller:r},i={template:'<article-page ctrl="ctrl" data="ctrl.data" state="ctrl.state"/>',controllerAs:"ctrl",controller:r};e.otherwise("/"),t.state("home",{url:"/",views:{viewArticle:c}}).state("category",{url:"/{pageId:library|jser}/category/{categoryId:.+}",views:{viewArticle:c}}).state("page",{url:"/{pageId:library|jser}",views:{viewArticle:c}}).state("article",{url:"/{pageId:library|jser}/{articleId:.+}",views:{viewArticle:i}}),r.$inject=["$stateParams","fetchArticleService"],angular.extend(r.prototype,{init:function(t,e){var a=this,r=a.config={fetchArticleService:e,pageNo:1};a.state=t,a.fetchData(r.pageNo)},initJserCategory:function(){{var t=this;t.config}"jser"==t.state.pageId&&(t.data.plugins_qty>0?t.data.jserCategory="1"==t.data.jp_flg?{type:"japanese-creator",name:"Japanese Creator"}:{type:"creator",name:"Creator"}:"1"==t.data.jp_flg&&(t.data.jserCategory={type:"japanese-reviewer",name:"Japanese Reviewer"}))},fetchData:function(t,e){var a=this,r=a.config;r.fetchArticleService.exec({page:a.state.pageId||"home",page_no:r.pageNo,category_id:a.state.categoryId||"*",single_id:a.state.articleId||"*"}).then(function(t){if(e&&a.data){var c=a.data.article_list.concat(t.article_list);a.data=t,a.data.article_list=c}else a.data=t;a.data.info=t.article_list_info[0],a.data.isNextPage=a.data.info.next_page_no>r.pageNo,a.data.isPrevPage=!1,a.state.articleId&&a.initJserCategory(),e||setTimeout(function(){document.body.scrollTop=0},0)})},nextPage:function(){var t=this,e=t.config;!t.state.articleId&&t.data.isNextPage&&(e.pageNo++,t.fetchData(e.pageNo,!0),t.data.isNextPage=!1)},prevPage:function(){var t=this,e=t.config;e.pageNo--,t.fetchData(e.pageNo)}});var n=function(){return document.body.scrollTop||document.documentElement.scrollTop},o=function(){return document.body.scrollHeight||document.documentElement.scrollHeight},l=angular.element(window);l.on("scroll",function(t){if(console.log(n(),o()),o()-1e3<n()){var e=document.querySelector(".next-page");e&&e.click()}})}]),app.directive("siteNav",function(){return{scope:{},restrict:"E",templateUrl:"directive/site_nav.html",controllerAs:"ctrl",controller:["CONFIG","$stateParams",function(t,e){var a=this;a.pageInfo=t.PAGE_INFO,a.state=e}]}}),app.directive("listPage",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/list_page.html"}}),app.directive("articlePage",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/article_page.html"}}),app.directive("libraryCard",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/library_card.html"}}),app.directive("jserCard",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/jser_card.html"}}),app.directive("libraryArticle",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/library_article.html"}}),app.directive("jserArticle",function(){return{scope:{c:"=ctrl",d:"=data",s:"=state"},restrict:"E",templateUrl:"directive/jser_article.html"}}),app.directive("categoryList",function(){return{scope:{},require:"categoryList",restrict:"E",templateUrl:"directive/category_list.html",link:function(t,e,a,r){r.init()},controllerAs:"ctrl",controller:["$scope","fetchCategoryService",function(t,e){var a=this;a.data={},a.init=function(){e.exec().then(function(t){a.data.category=t})}}]}});